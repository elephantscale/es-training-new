SQL EXERCISES ON ATHENA

Table Schema regarding Column names and Column Types referrenced 

CREATE EXTERNAL TABLE `prosper_loan_data_csv`(
  `term` int, 
  `loanstatus` int, 
  `borrowerrate` int, 
  `prosperrating` int, 
  `prosperscore` int, 
  `listingcategory` string, 
  `borrowerstate` string, 
  `employmentstatus` string, 
  `employmentstatusduration` int, 
  `isborrowerhomeowner` boolean, 
  `creditscore` int, 
  `currentcreditlines` int, 
  `opencreditlines` int, 
  `totalcreditlinespast7years` int, 
  `openrevolvingaccounts` int, 
  `openrevolvingmonthlypayment` int, 
  `inquirieslast6months` int, 
  `totalinquiries` int, 
  `currentdelinquencies` int, 
  `amountdelinquent` int, 
  `delinquencieslast7years` int, 
  `publicrecordslast10years` int, 
  `publicrecordslast12months` int, 
  `revolvingcreditbalance` int, 
  `bankcardutilization` int, 
  `availablebankcardcredit` int, 
  `totaltrades` int, 
  `tradesneverdelinquent` int, 
  `tradesopenedlast6months` int, 
  `debttoincomeratio` int, 
  `incomeverifiable` string, 
  `statedmonthlyincome` int, 
  `totalprosperloans` int, 
  `totalprosperpaymentsbilled` int, 
  `ontimeprosperpayments` int, 
  `prosperpaymentslessthanonemonthlate` int, 
  `prosperpaymentsonemonthpluslate` int, 
  `prosperprincipalborrowed` int, 
  `prosperprincipaloutstanding` int, 
  `loanoriginalamount` int, 
  `monthlyloanpayment` int, 
  `recommendations` int, 
  `investmentfromfriendscount` int, 
  `investmentfromfriendsamount` int, 
  `investors` int, 
  `yearswithcredit` int)
ROW FORMAT DELIMITED 
  FIELDS TERMINATED BY ',' 
STORED AS INPUTFORMAT 
  'org.apache.hadoop.mapred.TextInputFormat' 
OUTPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION
  's3://location_of_bucket/'
TBLPROPERTIES (
  'has_encrypted_data'='false', 
  'transient_lastDdlTime'='1554978556')

COLUMN NAMES IN prosper_loan_data_csv
 [1] "Term"                                "LoanStatus"                         
 [3] "BorrowerRate"                        "ProsperRating (numeric)"            
 [5] "ProsperScore"                        "ListingCategory"                    
 [7] "BorrowerState"                       "EmploymentStatus"                   
 [9] "EmploymentStatusDuration"            "IsBorrowerHomeowner"                
[11] "CreditScore"                         "CurrentCreditLines"                 
[13] "OpenCreditLines"                     "TotalCreditLinespast7years"         
[15] "OpenRevolvingAccounts"               "OpenRevolvingMonthlyPayment"        
[17] "InquiriesLast6Months"                "TotalInquiries"                     
[19] "CurrentDelinquencies"                "AmountDelinquent"                   
[21] "DelinquenciesLast7Years"             "PublicRecordsLast10Years"           
[23] "PublicRecordsLast12Months"           "RevolvingCreditBalance"             
[25] "BankcardUtilization"                 "AvailableBankcardCredit"            
[27] "TotalTrades"                         "TradesNeverDelinquent (percentage)" 
[29] "TradesOpenedLast6Months"             "DebtToIncomeRatio"                  
[31] "IncomeVerifiable"                    "StatedMonthlyIncome"                
[33] "TotalProsperLoans"                   "TotalProsperPaymentsBilled"         
[35] "OnTimeProsperPayments"               "ProsperPaymentsLessThanOneMonthLate"
[37] "ProsperPaymentsOneMonthPlusLate"     "ProsperPrincipalBorrowed"           
[39] "ProsperPrincipalOutstanding"         "LoanOriginalAmount"                 
[41] "MonthlyLoanPayment"                  "Recommendations"                    
[43] "InvestmentFromFriendsCount"          "InvestmentFromFriendsAmount"        
[45] "Investors"                           "YearsWithCredit"                    

SAMPLE QUERY 

SELECT ProsperScore, EmploymentStatus, IsBorrowerHomeowner, CreditScore, COUNT(*) 
FROM prosper_loan_data_csv
WHERE LoanStatus = 0
GROUP BY ProsperScore, EmploymentStatus, IsBorrowerHomeowner, CreditScore 
 
AGGREGATE VIEW OF BORROWERS WHO ARE NOT HOME OWNERS AND HAVE LOAN STATUS = '0'. THE VIEW SHOULD INCLUDE THEIR PROSPER SCORE, AVERAGE CREDIT SCORE FOR THE GROUP. THE AGGREGATE SHOULD CLASSIFY THE GROUP BY EMPLOYMENT STATUS

SELECT LoanStatus, IsBorrowerHomeowner,
	  ProsperScore, 
	  EmploymentStatus,  
	  AVG(CreditScore), 
	  COUNT(*) 
FROM prosper_loan_data_csv
WHERE LoanStatus = 0 AND
NOT(IsBorrowerHomeowner)
GROUP BY LoanStatus, IsBorrowerHomeowner, ProsperScore, EmploymentStatus

PROFILE AND DISTRIBUTION OF TOTAL LOANS OUTSTANDING FOR BORROWERS WHOSE LOAN STATUS IS '1' AND ARE HOMEOWNERS. PROFILE SHOULD INCLUDE EMPLOYMENT STATUS, PROSPER SCORE AND CREDIT SCORE

SELECT  LoanStatus, ProsperScore, EmploymentStatus, IsBorrowerHomeowner, 
	  CreditScore, 
	  SUM (ProsperPrincipalOutstanding) AS TotalProsperPrincipalOutstanding,
	  COUNT(*)
FROM prosper_loan_data_csv
WHERE 
	LoanStatus = 1 AND 
	IsBorrowerHomeowner 
GROUP BY 
	  LoanStatus, ProsperScore, EmploymentStatus, IsBorrowerHomeowner, CreditScore
ORDER BY TotalProsperPrincipalOutstanding DESC 
 
 
QUERY TO VIEW THE FOLLOWING DETAILS FOR THE GROUP WHO HAVE NOT HAD ANY DELAY IN PAYMENTS - 
(a) LOAN STATUS
(b) BORROWER STATE
(c) PROSPER SCORE
(d) IS BORROWER A HOME OWNER
(e) AVERAGE CREDIT SCORE FOR THE GROUP
(f) ON TIME PAYMENTS 
(g) DELAY IN PAYMENTS 
(h) SUM AND AVERAGE OF THE FOLLOWING
	(i)  ProsperPrincipalOutstanding
	(ii) AmountDelinquent
	(iii)CurrentDelinquencies
 

 
SELECT *
FROM 	
	(SELECT 	
		LoanStatus, BorrowerState, ProsperScore, IsBorrowerHomeowner, 
		AVG(CreditScore) AS AvgCreditScore,
		SUM(OnTimeProsperPayments) As OnTimeProsperPayments, 
		(SUM(ProsperPaymentsLessThanOneMonthLate)+SUM(ProsperPaymentsOneMonthPlusLate)) AS DelayinProsperPayments,
		SUM(ProsperPrincipalOutstanding) AS SumProsperPrincipalOutstanding,
		AVG(ProsperPrincipalOutstanding) AS AvgProsperPrincipalOutstanding,
		AVG(AmountDelinquent) AS AvgAmountDelinquent, 
		SUM(AmountDelinquent) AS SumAmountDelinquent, 
		AVG(CurrentDelinquencies) AS AvgCurrentDelinquencies,
		SUM(CurrentDelinquencies) AS SumCurrentDelinquencies
	FROM 	prosper_loan_data_csv
	WHERE 	ProsperPrincipalOutstanding > 0
	GROUP BY 
			LoanStatus, BorrowerState, ProsperScore, IsBorrowerHomeowner, CreditScore)
WHERE DelayinProsperPayments > 0